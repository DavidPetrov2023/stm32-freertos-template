# HAL + FreeRTOS library for NUCLEO-G070RB

# ---- Inputs from the top-level ----
# Expected variables defined in the root CMakeLists:
#   set(MCU_FLAGS -mcpu=cortex-m0plus -mthumb)
#   set(COMMON_C_FLAGS -ffunction-sections -fdata-sections -fno-builtin -Wall -Wextra)
#   set(LD_FLAGS -Wl,--gc-sections)

set(BOARD nucleo_g070rb)
set(CUBE_DIR ${CMAKE_CURRENT_LIST_DIR}/cube)

# --- Startup & linker script ---
file(GLOB STARTUP_S ${CUBE_DIR}/startup*.s)
file(GLOB LINKER_LD ${CUBE_DIR}/*FLASH*.ld)

# --- Core sources (excluding main.c) ---
file(GLOB_RECURSE CORE_SRCS
    ${CUBE_DIR}/Core/Src/*.c
)
# Keep CubeMX-generated sources (gpio.c, app_freertos.c, â€¦), but exclude main.c
list(FILTER CORE_SRCS EXCLUDE REGEX ".*/Core/Src/main\\.c$")

# --- HAL sources ---
file(GLOB_RECURSE HAL_SRCS
    ${CUBE_DIR}/Drivers/STM32G0xx_HAL_Driver/Src/*.c
)
# Exclude RTC timebase templates generated by CubeMX (can cause conflicts)
list(FILTER HAL_SRCS EXCLUDE REGEX ".*/stm32g0xx_hal_timebase_rtc_.*_template\\.c$")

# --- FreeRTOS kernel ---
file(GLOB FREERTOS_KERNEL
    ${CUBE_DIR}/Middlewares/Third_Party/FreeRTOS/Source/*.c
)

# --- FreeRTOS port (ARM_CM0 / ARM_CM0PLUS) ---
# Select the correct port.c from the corresponding subfolder
file(GLOB FREERTOS_PORT
    ${CUBE_DIR}/Middlewares/Third_Party/FreeRTOS/Source/portable/GCC/*/port.c
)

# --- FreeRTOS heap implementation ---
# Any heap_X.c, typically heap_4.c
file(GLOB FREERTOS_HEAP
    ${CUBE_DIR}/Middlewares/Third_Party/FreeRTOS/Source/portable/MemMang/heap*.c
)

# --- Optional CMSIS-RTOS v2 wrapper ---
file(GLOB FREERTOS_CMSISV2
    ${CUBE_DIR}/Middlewares/Third_Party/FreeRTOS/Source/CMSIS_RTOS_V2/*.c
)

# --- Cube/HAL/FreeRTOS static library ---
add_library(cube_fw_${BOARD} STATIC
    ${STARTUP_S}
    ${CORE_SRCS}
    ${HAL_SRCS}
    ${FREERTOS_KERNEL}
    ${FREERTOS_PORT}
    ${FREERTOS_HEAP}
    ${FREERTOS_CMSISV2}
)
add_library(cube_fw ALIAS cube_fw_${BOARD})

# --- Include paths ---
target_include_directories(cube_fw_${BOARD} PUBLIC
    ${CMAKE_CURRENT_LIST_DIR}  
    ${CUBE_DIR}/Core/Inc
    ${CUBE_DIR}/Drivers/CMSIS/Include
    ${CUBE_DIR}/Drivers/CMSIS/Device/ST/STM32G0xx/Include
    ${CUBE_DIR}/Drivers/STM32G0xx_HAL_Driver/Inc
    ${CUBE_DIR}/Drivers/STM32G0xx_HAL_Driver/Inc/Legacy
    ${CUBE_DIR}/Middlewares/Third_Party/FreeRTOS/Source/include
    ${CUBE_DIR}/Middlewares/Third_Party/FreeRTOS/Source/portable/GCC/ARM_CM0
    ${CUBE_DIR}/Middlewares/Third_Party/FreeRTOS/Source/portable/GCC/ARM_CM0PLUS
    ${CUBE_DIR}/Middlewares/Third_Party/FreeRTOS/Source/CMSIS_RTOS_V2

    # --- add these (project-level headers) ---
    ${CMAKE_SOURCE_DIR}/drivers
    ${CMAKE_SOURCE_DIR}/interfaces
    ${CMAKE_SOURCE_DIR}/instances
)

# --- Definitions & compile options ---
target_compile_definitions(cube_fw_${BOARD} PUBLIC
    STM32G070xx
    USE_HAL_DRIVER
)
target_compile_options(cube_fw_${BOARD} PUBLIC
    ${MCU_FLAGS}
    ${COMMON_C_FLAGS}
)

# --- Linker flags (exported globally for the application) ---
# NOTE: -T<file> must remain a single list entry (no space after -T)
set(CUBE_LINK_FLAGS
    ${MCU_FLAGS}
    ${LD_FLAGS}
    -T${LINKER_LD}
)
set_property(GLOBAL PROPERTY CUBE_LINK_FLAGS "${CUBE_LINK_FLAGS}")

# --- Board BSP wrapper (board_init, board_config.h) ---
add_library(board_bsp STATIC
    ${CMAKE_CURRENT_LIST_DIR}/board.c
    ${CMAKE_CURRENT_LIST_DIR}/board_error.c
)

target_include_directories(board_bsp PUBLIC
    ${CMAKE_CURRENT_LIST_DIR}   # provides board_config.h
)

# board_bsp depends on HAL (HAL_Init, SystemClock_Config, MX_GPIO_Init)
target_link_libraries(board_bsp PRIVATE cube_fw_${BOARD})
add_library(board_bsp::board_bsp ALIAS board_bsp)
